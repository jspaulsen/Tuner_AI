<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boosted 4.0 TunerAI</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="modal.css">
</head>

<body>
  <div id="app">
    <div class="modal">
      <div class="modal_content">
          <span class="close_button">&times;</span>
          <form class="modal_form">
            <label for="year">Year</label>
            <input type="text" id="year" name="year" placeholder="2019" required>
            <br>
            <label for="make">Make</label>
            <input type="text" id="make" name="make" placeholder="Toyota" required>
            <br>
            <label for="model">Model</label>
            <input type="text" id="model" name="model" placeholder="Corolla" required>
            <br>
            <label form="part">Part</label>
            <input type="text" id="part" name="part" placeholder="Transmission">

            <br>
            <!-- Button -->
            <button class="modal_submit" type="button">Submit</button>
          </form>
      </div>
    </div>
    <div id="header_container">
      <div id="header_text"></div>
      <img src="assets/cog.svg" onclick="toggleModal(false)"/>
    </div>
    <div id="chat_container"></div>
    <form id="chat_form">
      <textarea name="prompt" rows="1" cols="1" placeholder="Ask Tuner..."></textarea>
      <button type="submit"><img src="assets/send.svg" /></button>
    </form>
  </div>

  <script type="module" src="script.js"></script>
  <script>
    let canExitModal = true;
    const modal = document.querySelector(".modal");
    const modalCloseButton = document.querySelector(".close_button");
    const modalSubmitButton = document.querySelector(".modal_submit");

    function setConfiguration() {
      const year = document.getElementById("year").value;
      const make = document.getElementById("make").value;
      const model = document.getElementById("model").value;
      const part = document.getElementById("part").value;

      let configuration = {
        year: year,
        make: make,
        model: model,
        part: part,
      };

      if (document.cookie.includes("configuration")) {
        configuration = {
          ...JSON.parse(document.cookie.split("configuration=")[1]),
          ...configuration,
        };
      }

      document.cookie = `configuration=${JSON.stringify(configuration)}`;
      canExitModal = true;

      toggleModal();
    }

    function toggleModal() {
      const modalExit = document.querySelector(".close_button");

      // if the cookie exists, set the values in the modal to the cookie values
      if (document.cookie.includes("configuration")) {
        const configuration = JSON.parse(
          document.cookie.split("configuration=")[1]
        );

        document.getElementById("year").value = configuration.year;
        document.getElementById("make").value = configuration.make;
        document.getElementById("model").value = configuration.model;
        document.getElementById("part").value = configuration.part;
      }

      if (canExitModal) {
        modalExit.style.display = "block";
      } else {
        modalExit.style.display = "none";
      }

      modal.classList.toggle("show-modal");
    }

    // TODO: this doesn't work well, if you go to drag-click it exists
    // function windowOnClick(event) {
    //   if (event.target === modal) {
    //     if (canExitModal) {
    //       toggleModal();
    //     }
    //   }
    // }

    modalCloseButton.addEventListener("click", toggleModal);
    modalSubmitButton.addEventListener("click", setConfiguration);
    window.addEventListener("click", windowOnClick);

    // if the password cookie is not set, redirect to login page
    if (!document.cookie.includes("password")) {
      window.location.href = "/login.html";
    }

    // if the configuration cookie is not set, open the modal
    if (!document.cookie.includes("configuration")) {
      canExitModal = false;
      toggleModal();
    }
  </script>
</body>

</html>
